{% extends 'core/islemler/islem_base.html' %}

{% block title %}Kontrast Ayarlama - Görüntü İşleme{% endblock %}

{% block islem_title %}Kontrast Ayarlama{% endblock %}

{% block islem_parametreleri %}
<div class="mb-3">
    <label class="form-label">Kontrast Yöntemi</label>
    <select class="form-select" id="kontrastYontemi">
        <option value="dogrusal">Doğrusal Kontrast Ayarlama</option>
        <option value="gamma">Gamma Düzeltmesi</option>
        <option value="logaritmik">Logaritmik Dönüşüm</option>
    </select>
</div>

<div id="dogrusalParametreler" class="mb-3">
    <label class="form-label">Kontrast Faktörü</label>
    <div class="d-flex align-items-center gap-2">
        <input type="range" class="form-range" id="kontrastFaktor" min="0.1" max="3.0" step="0.1" value="1.0">
        <span id="kontrastDeger">1.0</span>
    </div>
</div>

<div id="gammaParametreler" class="mb-3" style="display: none;">
    <label class="form-label">Gamma Değeri</label>
    <div class="d-flex align-items-center gap-2">
        <input type="range" class="form-range" id="gammaFaktor" min="0.1" max="5.0" step="0.1" value="1.0">
        <span id="gammaDeger">1.0</span>
    </div>
</div>

<div class="mb-3">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="kanalBazli">
        <label class="form-check-label" for="kanalBazli">
            Renk Kanallarını Ayrı İşle
        </label>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const kontrastYontemi = document.getElementById('kontrastYontemi');
    const dogrusalParametreler = document.getElementById('dogrusalParametreler');
    const gammaParametreler = document.getElementById('gammaParametreler');
    const kontrastFaktor = document.getElementById('kontrastFaktor');
    const gammaFaktor = document.getElementById('gammaFaktor');
    const kontrastDeger = document.getElementById('kontrastDeger');
    const gammaDeger = document.getElementById('gammaDeger');
    const kanalBazli = document.getElementById('kanalBazli');
    const processButton = document.getElementById('processButton');
    const imageInput = document.getElementById('imageInput');
    const originalImage = document.getElementById('originalImage');
    const processedImage = document.getElementById('processedImage');
    const originalPlaceholder = document.getElementById('originalPlaceholder');
    const processedPlaceholder = document.getElementById('processedPlaceholder');

    // CSRF token al
    const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    console.log('CSRF Token:', csrftoken); // Debug için

    // Görüntü yükleme işleyicisi
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            console.log('Seçilen dosya:', file.name); // Debug için
            // Seçilen görüntüyü göster
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage.src = e.target.result;
                originalImage.style.display = 'block';
                originalPlaceholder.style.display = 'none';
                
                // İşlem butonunu aktif et
                processButton.disabled = false;
            };
            reader.readAsDataURL(file);
        }
    });

    kontrastYontemi.addEventListener('change', function() {
        dogrusalParametreler.style.display = this.value === 'dogrusal' ? 'block' : 'none';
        gammaParametreler.style.display = this.value === 'gamma' ? 'block' : 'none';
    });

    kontrastFaktor.addEventListener('input', function() {
        kontrastDeger.textContent = this.value;
    });

    gammaFaktor.addEventListener('input', function() {
        gammaDeger.textContent = this.value;
    });

    processButton.addEventListener('click', async function() {
        if (!imageInput.files[0]) {
            alert('Lütfen bir görüntü seçin');
            return;
        }

        // İşlem başladığında butonu devre dışı bırak
        processButton.disabled = true;
        processButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> İşleniyor...';

        try {
            // Form verilerini oluştur
            const formData = new FormData();
            formData.append('image', imageInput.files[0]);
            formData.append('yontem', kontrastYontemi.value);
            formData.append('kontrastFaktor', kontrastFaktor.value);
            formData.append('gammaFaktor', gammaFaktor.value);
            formData.append('kanalBazli', kanalBazli.checked);

            // Debug için konsola yazdır
            console.log('Gönderilen parametreler:', {
                yontem: kontrastYontemi.value,
                kontrastFaktor: kontrastFaktor.value,
                gammaFaktor: gammaFaktor.value,
                kanalBazli: kanalBazli.checked
            });

            // İşlemi gerçekleştir
            const response = await fetch('/kontrast/isle/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData,
                credentials: 'same-origin'  // CSRF için önemli
            });

            console.log('Sunucu yanıtı status:', response.status);
            const data = await response.json();
            console.log('Sunucu yanıtı data:', data);

            if (!response.ok) {
                throw new Error(data.error || 'Sunucu hatası oluştu');
            }

            if (data.success) {
                // İşlenmiş görüntüyü göster
                processedImage.src = data.image;
                processedImage.style.display = 'block';
                processedPlaceholder.style.display = 'none';
            } else {
                throw new Error(data.error || 'İşlem başarısız oldu');
            }
        } catch (error) {
            console.error('Hata:', error);
            alert('Hata: ' + error.message);
            processedImage.style.display = 'none';
            processedPlaceholder.style.display = 'block';
            processedPlaceholder.innerHTML = '<div class="alert alert-danger">İşlem sırasında bir hata oluştu</div>';
        } finally {
            // İşlem bittiğinde butonu tekrar aktif et
            processButton.disabled = false;
            processButton.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';
        }
    });
});
</script>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
</style>
{% endblock %} 