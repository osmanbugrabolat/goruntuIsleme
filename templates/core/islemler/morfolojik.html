{% extends 'core/islemler/islem_base.html' %}

{% block title %}Morfolojik İşlemler - Görüntü İşleme{% endblock %}

{% block islem_title %}Morfolojik İşlemler{% endblock %}

{% block islem_parametreleri %}
<div class="mb-3">
    <label class="form-label">Morfolojik İşlem Türü</label>
    <select class="form-select" id="islemTuru">
        <option value="genisletme">Genişletme (Dilation)</option>
        <option value="erozyon">Erozyon (Erosion)</option>
        <option value="acma">Açma (Opening)</option>
        <option value="kapama">Kapama (Closing)</option>
        <option value="gradyan">Morfolojik Gradyan</option>
    </select>
</div>

<div class="mb-3">
    <label class="form-label">Yapısal Element Şekli</label>
    <select class="form-select" id="yapisalElement">
        <option value="kare">Kare</option>
        <option value="dikdortgen">Dikdörtgen</option>
        <option value="elips">Elips</option>
        <option value="cross">Çapraz (Cross)</option>
    </select>
</div>

<div class="mb-3">
    <label class="form-label">Yapısal Element Boyutu</label>
    <div class="row">
        <div class="col">
            <label class="form-label">Genişlik</label>
            <div class="d-flex align-items-center gap-2">
                <input type="range" class="form-range" id="genislik" min="3" max="21" step="2" value="3">
                <span id="genislikDeger">3</span>
            </div>
        </div>
        <div class="col">
            <label class="form-label">Yükseklik</label>
            <div class="d-flex align-items-center gap-2">
                <input type="range" class="form-range" id="yukseklik" min="3" max="21" step="2" value="3">
                <span id="yukseklikDeger">3</span>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="onIslemUygula">
        <label class="form-check-label" for="onIslemUygula">
            İkili Görüntüye Dönüştür (Thresholding)
        </label>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
// Boyut değerlerini güncelleme
document.getElementById('genislik').addEventListener('input', function() {
    document.getElementById('genislikDeger').textContent = this.value;
});

document.getElementById('yukseklik').addEventListener('input', function() {
    document.getElementById('yukseklikDeger').textContent = this.value;
});

// İşlem butonuna tıklandığında
processButton.addEventListener('click', async function() {
    if (!imageInput.files[0]) {
        alert('Lütfen bir görüntü seçin');
        return;
    }

    // İşlem başladığında butonları devre dışı bırak
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> İşleniyor...';

    // İşlem parametrelerini al
    const islemTuru = document.getElementById('islemTuru').value;
    const yapisalElement = document.getElementById('yapisalElement').value;
    const genislikDegeri = document.getElementById('genislik').value;
    const yukseklikDegeri = document.getElementById('yukseklik').value;
    const onIslemUygula = document.getElementById('onIslemUygula').checked;

    // Debug için parametreleri yazdır
    console.log('Morfolojik işlem parametreleri:', {
        islemTuru,
        yapisalElement,
        genislik: genislikDegeri,
        yukseklik: yukseklikDegeri,
        onIslemUygula
    });

    try {
        // Form verilerini oluştur
        const formData = new FormData();
        formData.append('image', imageInput.files[0]);
        formData.append('islemTuru', islemTuru);
        formData.append('yapisalElement', yapisalElement);
        formData.append('genislik', genislikDegeri);
        formData.append('yukseklik', yukseklikDegeri);
        formData.append('onIslemUygula', onIslemUygula);

        // CSRF token ekle
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // İşlemi başlat
        const response = await fetch('/morfolojik/isle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'İşlem sırasında bir hata oluştu');
        }

        const data = await response.json();

        // İşlenmiş görüntüyü göster
        processedImage.src = data.image;
        processedImage.style.display = 'block';
        processedPlaceholder.style.display = 'none';

    } catch (error) {
        console.error('Hata:', error);
        alert('Hata: ' + error.message);
    } finally {
        // İşlem bittiğinde butonları tekrar aktif et
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';
    }
});
</script>
{% endblock %} 