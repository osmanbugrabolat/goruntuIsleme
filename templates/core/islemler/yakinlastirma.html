{% extends 'core/islemler/islem_base.html' %}
{% load static %}

{% block title %}Yakınlaştırma/Uzaklaştırma{% endblock %}

{% block islem_title %}Yakınlaştırma/Uzaklaştırma{% endblock %}

{% block islem_parametreleri %}
<div class="mb-3">
    <label for="olcek_faktoru" class="form-label">Ölçek Faktörü: <span id="olcek_faktoru_deger">1.0</span>x</label>
    <input type="range" class="form-range" id="olcek_faktoru" min="0.1" max="5.0" step="0.1" value="1.0">
    <small class="form-text text-muted">0.1x (küçültme) ile 5.0x (büyütme) arasında bir değer seçin</small>
</div>

<div class="mb-3">
    <label for="interpolasyon" class="form-label">İnterpolasyon Yöntemi:</label>
    <select class="form-select" id="interpolasyon">
        <option value="nearest">En Yakın Komşu</option>
        <option value="linear" selected>Bilineer</option>
        <option value="cubic">Bikübik</option>
        <option value="lanczos">Lanczos</option>
    </select>
</div>

<div class="mb-3 form-check">
    <input type="checkbox" class="form-check-input" id="antiAliasing" checked>
    <label class="form-check-label" for="antiAliasing">Anti-aliasing (Küçültme işleminde)</label>
</div>
{% endblock %}

{% block islem_js %}
document.addEventListener('DOMContentLoaded', function() {
    // Elementleri seç
    const olcekFaktoru = document.getElementById('olcek_faktoru');
    const olcekFaktoruDeger = document.getElementById('olcek_faktoru_deger');
    const processButton = document.getElementById('processButton');
    const originalImageArea = document.querySelector('.original-image-area');
    const processedImageArea = document.querySelector('.processed-image-area');
    const processedPlaceholder = document.getElementById('processedPlaceholder');
    const processedImage = document.getElementById('processedImage');
    const imageInput = document.getElementById('imageInput'); // Tek bir yerde tanımla

    // Ölçek faktörü değerini güncelle
    olcekFaktoru.addEventListener('input', function() {
        olcekFaktoruDeger.textContent = this.value + 'x';
    });

    // Görüntü yüklendiğinde
    imageInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Orijinal görüntüyü göster
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-fluid';
                img.alt = 'Orijinal Görüntü';
                originalImageArea.innerHTML = '';
                originalImageArea.appendChild(img);
                processButton.disabled = false;
            }
            
            reader.readAsDataURL(file);
        }
    });

    // İşlem başlatma butonu tıklandığında
    processButton.addEventListener('click', async function() {
        if (!imageInput.files[0]) {
            alert('Lütfen bir görüntü seçin');
            return;
        }

        // İşlem başladığında butonu devre dışı bırak
        processButton.disabled = true;
        processButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> İşleniyor...';
        
        // İşlenmiş görüntü placeholder'ını gizle
        processedPlaceholder.style.display = 'none';
        processedImage.style.display = 'none';
        
        try {
            const formData = new FormData();
            formData.append('image', imageInput.files[0]);
            
            // Ölçek faktörünü doğru formatta gönder
            const olcekDegeri = parseFloat(olcekFaktoru.value);
            if (isNaN(olcekDegeri) || olcekDegeri <= 0 || olcekDegeri > 5.0) {
                throw new Error('Geçersiz ölçek faktörü: 0.1 ile 5.0 arasında bir değer olmalı');
            }
            formData.append('olcek_faktoru', olcekDegeri);
            
            formData.append('interpolasyon', document.getElementById('interpolasyon').value);
            formData.append('antiAliasing', document.getElementById('antiAliasing').checked);

            console.log('Gönderilen parametreler:', {
                olcek_faktoru: olcekDegeri,
                interpolasyon: document.getElementById('interpolasyon').value,
                antiAliasing: document.getElementById('antiAliasing').checked
            });

            const response = await fetch('/yakinlastirma/isle/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            console.log('Sunucu yanıtı:', data);

            if (!response.ok) {
                throw new Error(data.error || 'Sunucu hatası oluştu');
            }

            if (data.success) {
                // İşlenmiş görüntüyü göster
                processedImage.src = data.processed_image;
                processedImage.style.display = 'block';
                processedPlaceholder.style.display = 'none';
                
                // Görüntü yüklendiğinde boyutları güncelle
                processedImage.onload = function() {
                    const originalImg = originalImageArea.querySelector('img');
                    if (originalImg) {
                        console.log('Orijinal boyutlar:', {
                            width: originalImg.naturalWidth,
                            height: originalImg.naturalHeight
                        });
                        console.log('İşlenmiş boyutlar:', {
                            width: processedImage.naturalWidth,
                            height: processedImage.naturalHeight
                        });
                    }
                };
            } else {
                throw new Error(data.error || 'İşlem başarısız oldu');
            }
        } catch (error) {
            console.error('Hata:', error);
            alert('Hata: ' + error.message);
            processedPlaceholder.style.display = 'block';
            processedImage.style.display = 'none';
        } finally {
            // İşlem bittiğinde butonu tekrar aktif et
            processButton.disabled = false;
            processButton.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';
        }
    });
});
{% endblock %} 