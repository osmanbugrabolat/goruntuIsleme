{% extends 'core/islemler/islem_base.html' %}

{% block title %}Görüntü Kırpma - Görüntü İşleme{% endblock %}

{% block islem_title %}Görüntü Kırpma{% endblock %}

{% block islem_parametreleri %}
<div class="mb-3">
    <label class="form-label">Kırpma Koordinatları</label>
    <div class="row g-2">
        <div class="col-6">
            <label class="form-label small">Başlangıç X</label>
            <input type="number" class="form-control" id="startX" min="0" value="0">
        </div>
        <div class="col-6">
            <label class="form-label small">Başlangıç Y</label>
            <input type="number" class="form-control" id="startY" min="0" value="0">
        </div>
        <div class="col-6">
            <label class="form-label small">Genişlik</label>
            <input type="number" class="form-control" id="width" min="1" value="100">
        </div>
        <div class="col-6">
            <label class="form-label small">Yükseklik</label>
            <input type="number" class="form-control" id="height" min="1" value="100">
        </div>
    </div>
</div>
<div class="mb-3">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="aspectRatio">
        <label class="form-check-label" for="aspectRatio">
            En-Boy Oranını Koru
        </label>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
// Görüntü seçildiğinde orijinal görüntüyü göster ve maksimum değerleri ayarla
document.getElementById('imageInput').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Görüntü boyutlarını al ve input sınırlarını ayarla
            const img = new Image();
            img.onload = function() {
                document.getElementById('width').max = img.width;
                document.getElementById('height').max = img.height;
                document.getElementById('startX').max = img.width - 1;
                document.getElementById('startY').max = img.height - 1;
                
                // Varsayılan değerleri güncelle
                document.getElementById('width').value = Math.min(100, img.width);
                document.getElementById('height').value = Math.min(100, img.height);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(this.files[0]);
    }
});

// İşlem butonuna tıklandığında
processButton.addEventListener('click', async function() {
    if (!imageInput.files[0]) {
        alert('Lütfen bir görüntü seçin');
        return;
    }

    // İşlem başladığında butonu devre dışı bırak
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>İşlem Yapılıyor...';

    try {
        // Görüntüyü base64'e çevir
        const reader = new FileReader();
        reader.readAsDataURL(imageInput.files[0]);
        
        reader.onload = async function() {
            try {
                // İşlem parametrelerini hazırla
                const data = {
                    image: reader.result,
                    startX: parseInt(document.getElementById('startX').value),
                    startY: parseInt(document.getElementById('startY').value),
                    width: parseInt(document.getElementById('width').value),
                    height: parseInt(document.getElementById('height').value),
                    aspectRatio: document.getElementById('aspectRatio').checked
                };
                
                // CSRF token al
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // İşlemi başlat
                const response = await fetch('/goruntu-kirpma/isle/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || 'İşlem sırasında bir hata oluştu');
                }

                const responseData = await response.json();

                // İşlenmiş görüntüyü göster
                processedImage.src = responseData.image;
                processedImage.style.display = 'block';
                processedPlaceholder.style.display = 'none';

                // İşlem başarılı olduğunda butonu tekrar aktif et
                processButton.disabled = false;
                processButton.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';

            } catch (error) {
                console.error('Hata:', error);
                alert('Hata: ' + error.message);
                // Hata durumunda butonu tekrar aktif et
                processButton.disabled = false;
                processButton.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';
            }
        };

    } catch (error) {
        console.error('Hata:', error);
        alert('Hata: ' + error.message);
        // Hata durumunda butonu tekrar aktif et
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';
    }
});
</script>
{% endblock %} 