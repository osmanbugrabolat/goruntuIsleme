{% extends 'core/islemler/islem_base.html' %}

{% block title %}Görüntü Kırpma - Görüntü İşleme{% endblock %}

{% block islem_title %}Görüntü Kırpma{% endblock %}

{% block islem_parametreleri %}
<div class="mb-3">
    <label class="form-label">Kırpma Koordinatları</label>
    <div class="row g-2">
        <div class="col-6">
            <label class="form-label small">Başlangıç X</label>
            <input type="number" class="form-control" id="startX" min="0" value="0">
        </div>
        <div class="col-6">
            <label class="form-label small">Başlangıç Y</label>
            <input type="number" class="form-control" id="startY" min="0" value="0">
        </div>
        <div class="col-6">
            <label class="form-label small">Genişlik</label>
            <input type="number" class="form-control" id="width" min="1" value="100">
        </div>
        <div class="col-6">
            <label class="form-label small">Yükseklik</label>
            <input type="number" class="form-control" id="height" min="1" value="100">
        </div>
    </div>
</div>
<div class="mb-3">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="aspectRatio">
        <label class="form-check-label" for="aspectRatio">
            En-Boy Oranını Koru
        </label>
    </div>
</div>
{% endblock %}

{% block islem_js %}
// Görüntü seçildiğinde orijinal görüntüyü göster ve maksimum değerleri ayarla
document.getElementById('imageInput').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Orijinal görüntüyü göster
            const originalArea = document.querySelector('.original-image-area');
            originalArea.innerHTML = `<img src="${e.target.result}" class="img-fluid" alt="Orijinal görüntü">`;
            
            // Görüntü boyutlarını al ve input sınırlarını ayarla
            const img = new Image();
            img.onload = function() {
                document.getElementById('width').max = img.width;
                document.getElementById('height').max = img.height;
                document.getElementById('startX').max = img.width - 1;
                document.getElementById('startY').max = img.height - 1;
                
                // Varsayılan değerleri güncelle
                document.getElementById('width').value = Math.min(100, img.width);
                document.getElementById('height').value = Math.min(100, img.height);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(this.files[0]);
    }
});

document.getElementById('processButton').addEventListener('click', async function() {
    try {
        // İşlenmiş görüntü alanına yükleme göstergesini ekle
        const processedArea = document.querySelector('.processed-image-area');
        processedArea.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
                <div class="mt-2">Görüntü İşleniyor...</div>
            </div>
        `;
        
        // Görüntüyü al
        const imageInput = document.getElementById('imageInput');
        if (!imageInput.files[0]) {
            alert('Lütfen bir görüntü seçin');
            return;
        }
        
        // Parametreleri al
        const startX = parseInt(document.getElementById('startX').value);
        const startY = parseInt(document.getElementById('startY').value);
        const width = parseInt(document.getElementById('width').value);
        const height = parseInt(document.getElementById('height').value);
        const aspectRatio = document.getElementById('aspectRatio').checked;
        
        // Görüntüyü base64'e dönüştür
        const base64Image = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(imageInput.files[0]);
        });
        
        // API'ye gönder
        const response = await fetch('/goruntu-kirpma/isle/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                image: base64Image,
                startX: startX,
                startY: startY,
                width: width,
                height: height,
                aspectRatio: aspectRatio
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Sonuç görüntüsünü göster
            processedArea.innerHTML = `<img src="${data.image}" class="img-fluid" alt="İşlenmiş görüntü">`;
        } else {
            alert('Hata: ' + data.error);
            // Hata durumunda varsayılan ikonu göster
            processedArea.innerHTML = `<i class="bi bi-image-alt display-1 text-gray-300"></i>`;
        }
    } catch (error) {
        alert('İşlem sırasında bir hata oluştu: ' + error.message);
        // Hata durumunda varsayılan ikonu göster
        const processedArea = document.querySelector('.processed-image-area');
        processedArea.innerHTML = `<i class="bi bi-image-alt display-1 text-gray-300"></i>`;
    }
});
{% endblock %} 