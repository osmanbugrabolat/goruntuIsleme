{% extends 'core/islemler/islem_base.html' %}

{% block title %}Kenar Algılama - Görüntü İşleme{% endblock %}

{% block islem_title %}Kenar Algılama{% endblock %}

{% block islem_parametreleri %}
<div class="mb-3">
    <label class="form-label">Kenar Algılama Yöntemi</label>
    <select class="form-select" id="yontem">
        <option value="sobel">Sobel Operatörü</option>
        <option value="prewitt">Prewitt Operatörü</option>
        <option value="canny">Canny Kenar Algılama</option>
        <option value="laplacian">Laplacian Operatörü</option>
    </select>
</div>

<div id="cannyParametreleri" style="display: none;">
    <div class="mb-3">
        <label class="form-label">Alt Eşik Değeri</label>
        <div class="d-flex align-items-center gap-2">
            <input type="range" class="form-range" id="altEsik" min="0" max="255" value="100">
            <span id="altEsikDeger">100</span>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Üst Eşik Değeri</label>
        <div class="d-flex align-items-center gap-2">
            <input type="range" class="form-range" id="ustEsik" min="0" max="255" value="200">
            <span id="ustEsikDeger">200</span>
        </div>
    </div>
</div>

<div id="sobelPrewittParametreleri" class="mb-3" style="display: none;">
    <label class="form-label">Yön</label>
    <select class="form-select" id="yon">
        <option value="yatay">Yatay (x)</option>
        <option value="dikey">Dikey (y)</option>
        <option value="her_iki">Her İki Yön</option>
    </select>
</div>

<div class="mb-3">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="onIslemUygula">
        <label class="form-check-label" for="onIslemUygula">
            Gürültü Azaltma Ön İşlemi Uygula
        </label>
    </div>
</div>

<div id="onIslemParametreleri" class="mb-3" style="display: none;">
    <label class="form-label">Gürültü Azaltma Filtre Boyutu</label>
    <div class="d-flex align-items-center gap-2">
        <input type="range" class="form-range" id="filtreBoyutu" min="3" max="7" step="2" value="3">
        <span id="filtreBoyutuDeger">3x3</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
// Parametre alanlarını kontrol et
document.getElementById('yontem').addEventListener('change', function() {
    document.getElementById('cannyParametreleri').style.display = 
        this.value === 'canny' ? 'block' : 'none';
    
    document.getElementById('sobelPrewittParametreleri').style.display = 
        ['sobel', 'prewitt'].includes(this.value) ? 'block' : 'none';
});

// Ön işlem parametrelerini kontrol et
document.getElementById('onIslemUygula').addEventListener('change', function() {
    document.getElementById('onIslemParametreleri').style.display = 
        this.checked ? 'block' : 'none';
});

// Eşik değerlerini güncelle
document.getElementById('altEsik').addEventListener('input', function() {
    document.getElementById('altEsikDeger').textContent = this.value;
    const ustEsik = document.getElementById('ustEsik');
    if (parseInt(this.value) > parseInt(ustEsik.value)) {
        ustEsik.value = this.value;
        document.getElementById('ustEsikDeger').textContent = this.value;
    }
});

document.getElementById('ustEsik').addEventListener('input', function() {
    document.getElementById('ustEsikDeger').textContent = this.value;
    const altEsik = document.getElementById('altEsik');
    if (parseInt(this.value) < parseInt(altEsik.value)) {
        altEsik.value = this.value;
        document.getElementById('altEsikDeger').textContent = this.value;
    }
});

// Filtre boyutunu güncelle
document.getElementById('filtreBoyutu').addEventListener('input', function() {
    document.getElementById('filtreBoyutuDeger').textContent = `${this.value}x${this.value}`;
});

// İşlem butonuna tıklandığında
processButton.addEventListener('click', async function() {
    if (!imageInput.files[0]) {
        alert('Lütfen bir görüntü seçin');
        return;
    }

    // İşlem başladığında butonları devre dışı bırak
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> İşleniyor...';

    // İşlem parametrelerini al
    const yontem = document.getElementById('yontem').value;
    const yon = document.getElementById('yon')?.value;
    const altEsik = document.getElementById('altEsik').value;
    const ustEsik = document.getElementById('ustEsik').value;
    const onIslemUygula = document.getElementById('onIslemUygula').checked;
    const filtreBoyutu = document.getElementById('filtreBoyutu').value;

    // Debug için parametreleri yazdır
    console.log('Kenar algılama parametreleri:', {
        yontem,
        yon,
        altEsik,
        ustEsik,
        onIslemUygula,
        filtreBoyutu
    });

    try {
        // Form verilerini oluştur
        const formData = new FormData();
        formData.append('image', imageInput.files[0]);
        formData.append('yontem', yontem);
        if (['sobel', 'prewitt'].includes(yontem)) {
            formData.append('yon', yon);
        }
        if (yontem === 'canny') {
            formData.append('altEsik', altEsik);
            formData.append('ustEsik', ustEsik);
        }
        formData.append('onIslemUygula', onIslemUygula);
        formData.append('filtreBoyutu', filtreBoyutu);

        // CSRF token ekle
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // İşlemi başlat
        const response = await fetch('/kenar-bulma/isle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'İşlem sırasında bir hata oluştu');
        }

        const data = await response.json();

        // İşlenmiş görüntüyü göster
        processedImage.src = data.image;
        processedImage.style.display = 'block';
        processedPlaceholder.style.display = 'none';

    } catch (error) {
        console.error('Hata:', error);
        alert('Hata: ' + error.message);
    } finally {
        // İşlem bittiğinde butonları tekrar aktif et
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-play-circle me-2"></i>İşlemi Başlat';
    }
});
</script>
{% endblock %} 